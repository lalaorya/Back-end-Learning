🤺🤺🤺🤺

## 数据链路层Note

#### ① 前言

   > 数据链路层使用的传输信道有两种：点对点信道和广播信道。
   >
   > 由于通信方式的不同，点对点方式使用的是PPP协议，广播信道使用的是CSMA/CD协议。

接下来看看数据链路层在网络传输中的位置：

<img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201031111102771.png" alt="image-20201031111102771" style="zoom:67%;" />

 如果从整个传输的视角看的话，主机间的数据链路层并不直接连接，而实通过物理层进行通信，因此不同的链路层可能采用的协议是不一样的，因为它只需要能够和它的物理层进行通信即可，和其他数据链路层没有半毛钱关系。

如果从链路层的视角看的话，主机间的链路层好像就是直接进行通信的。

这种把计算机网络分层研究的思想有利于我们研究每一层的功能和实现。

#### ② 数据链路层的基本问题

1. 设计数据链路层的原因

   >设计数据链路层的主要目的是在有差错的物理线路的基础上，采取差错检测、差错控制与流量控制等方法，将有差错的物理线路改进成无差错的数据链路，**向网络层提供高质量的数据传输服务。**
   >
   >因此数据链路层的基本问题是：封装成帧、透明传输和差错检测

2. 链路层的协议数据单元——帧

   > 数据链路层把网络层的协议单元数据报封装成帧发送到链路上，以及把接收到的帧中的数据取出上交给网络层。
   >
   > <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201031113141729.png" alt="image-20201031113141729" style="zoom:67%;" />
   >
   > author大白话：
   >
   > 链路层提供的是无差错传输与可靠传输

3. 三个基本问题

   - 封装成帧

     > 在数据的前后分别添加首部和尾部，进行帧定界，方便对等的链路层识别帧。帧是数据链路层传输的基本单位。
     >
     > <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201031162826623.png" alt="image-20201031162826623" style="zoom:67%;" />
     >
     > 每个链路层协议都会规定帧首部和尾部的格式，并且规定数据部分的长度上限MTU。
     >
     > 举个栗子：🤺🤺
     >
     > 当数据部分是由可打印的ASCII码组成时，帧定界可以使用不可打印的ASCII码SOH(00000001)作为帧首部，EOH(00000100)作为帧尾部。
     >
     > 只有接收端收到SOH和EOH时才会收下这个帧。
     >
     > <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201031163913195.png" alt="image-20201031163913195" style="zoom:67%;" />

   - 透明传输

     > 当上层交付的数据中出现帧定界符时，会使链路层错误判断的找到帧的边界，导致通信错误。透明传输正是为了解决这点。

     具体的方法有两种：

     ① 当物理层信道面向字节传输时：字节填充法

     发送端的数据链路层在数据中出现栈定界符的前面插入一个转义字符"ESC(00011011)"。接收端的数据链路层在将数据上交给网络层时会删除这个转义字符。从而实现透明传输。

     ② 当物理层信道面向比特传输时：比特填充法

     同样，发送端的链路层遍历数据，当出现五个连续的0时，在后面插入一个1，破坏数据中的帧定界符。接收端上交数据时，会把数据中五个连续0后的的1删除。从而实现透明传输。

   - 差错检测

     > 物理层在传输时收到信噪比的影响，可能会出现传输错误，比如比特0传输为比特1。因为我们需要对传输的数据进行差错检测，如果发现了错误，就丢弃该数据帧或者重传。
     >
     > 注意：差错检测是以帧为单位的。

     我们一般使用循环冗余检验CRC进行差错检测。

     先简要说一下什么是CRC？

     > 通信之前，双方都规定了一个多项式(也叫生成多项式)，本质来说就是一段比特数据。比如规定的多项式是：$X^3+X+1$，那么这个多项式就是1011。
     >
     > 发送端的数据链路层通过模二运算得出冗余码FCS，并把FCS插入到数据的尾部。
     >
     > 接收端的数据链路层收到数据后，就把数据和之前规定的多项式进行相除，如果余数为0，说明这个帧没有出现比特错误，接收。如果余数不为0，说明这个帧出现错误。
     >
     > 接收端添加冗余码和发送端检测余数都是由硬件完成的，因此不会对传输的效率有很大的影响。

     下面我们通过一个栗子来看看CRC是怎么用的

     **发送端FCS的计算：**

     ![image-20201031174040542](../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201031174040542.png)

     **接收端的检测：**

     <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201031174602314.png" alt="image-20201031174602314" style="zoom:80%;" />

#### ③ PPP协议

   - PPP协议需要实现的功能

     > 随着通信线路质量的提高与光纤的广泛应用，物理层误码率明显降低。同时TCP/IP协议中，TCP协议已经采取了一系列差错控制措施。
     >
     > 因此PPP协议只需实现帧封装、传输、拆帧与CRC校验功能。不使用帧序号，不提供流量控制功能。
     >
     > **author大白话：**
     >
     > 总的来说，链路层的PPP协议只需要把上层交付的数据封装成帧，传输到点对点通信的链路层，接收端进行CRC检验，出错丢弃，不出错接收并上交即可。其他的比如帧排序，实现可靠通信，都由上层协议完成。
     >
     > #ppp协议的附属协议：实现数据链路连接的链路控制协议LCP，网络控制协议NCP

- PPP协议的帧格式

  <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201102153345383.png" alt="image-20201102153345383" style="zoom:80%;" />

  > - F：Flag，帧定界符，标志帧长度的字段
  >
  > - A：Address，地址字段
  >
  > - C：控制字段
  >
  >   *地址字段和控制字段没有有效的信息，被设计出来以后用的，可惜现在也没用上*
  >
  > - FCS：CRC检验序列

   - PPP协议是如何解决三个基本问题的？

     1. 透明传输问题

        - 用于异步传输时：字节填充

          > 转义字符定义为*0x7D*
          >
          > 当出现*0x7E*时，转变成*0x7D*,*0x7E*；当出现*0x7D*时，转变成*0x7D*,*0x5D*
          >
          > 接收端进行与之相反的变化，即可还原出正确的信息。

        - 用于同步传输时：字符填充

          > 因为0x7E是01111110，因此发送端在发送之前扫描整个字段，只要发现5个0，就填充一个1，把原信息中的ox7E破坏掉

     2. 差错检测

        使用CRC冗余校验

   - PPP协议的工作状态

     不多说，直接上图：

     <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201114154824600.png" alt="image-20201114154824600" style="zoom:67%;" />

     >author大白话
     >
     >PPP协议不仅应用于拨号电话线ISP，并且在路由器-路由器之间的专用线路上也都广泛地使用。它是通过向路由器发送多个PPP帧，先建立物理链路，再实现网络层协议，最终实行通信。可以PPP协议已经不单纯是链路层的协议了，还包含物理层和网络层协议。
     >
     >PPP协议既支持异步传输链路，也支持同步传输链路

#### ④ 使用广播信道的链路层

   > 前面提到的PPP协议是基于点对点信道的通信，但是当前局域网采用的是基于广播信道的通信，可以实现一对多。
   >
   > 广播信道的分类是以网络拓扑结构进行分类的，有星形网、环形网和总线网。总线网使用的最多，传统的以太网就是采用总线网的结构。
   >
   > <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201115192617241.png" alt="image-20201115192617241" style="zoom:67%;" />

1. 广播信道的冲突问题

   > 共享信道要考虑的一个问题就是如何协调多个发送和接收站点对一个共享传输媒体(共享信道)的占用，即媒体接入控制问题(MAC)。
   >
   > author大白话：
   >
   > 也就是说，多个用户要共享同一条信道，肯定会产生碰撞，广播信道的协议重点就是如何解决冲突问题.
   >
   > <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201115193203375.png" alt="image-20201115193203375" style="zoom:67%;" />

2. 如何解决MAC问题

   > ![image-20201115193419054](../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201115193419054.png)
   >
   > author大白话：
   >
   > 解决方法有两种，一种是我们在物理层学到的信道复用技术。另外一种则是多点接入技术。CSMA/CD协议采用的就是多点接入技术。

3. 以太网的数据链路层

   > 以太网把数据链路层分为LLC层即逻辑链路控制层和MAC层即媒体接入控制层。但是因为标准和市场的冲突，现在已经剩下MAC层了。
   >
   > <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201115193946930.png" alt="image-20201115193946930" style="zoom:67%;" />

4. 适配器

   > 适配器是插在主机的一张网络接口板，又叫网卡。用于实现计算机与局域网的通信。
   >
   > 适配器通过并行传输的方式从系统接收IP数据报并封装成帧，通过串行传输的方式从局域网接收数据帧并交互网络层。因此适配器要实现的功能有：
   >
   > - 实现并行传输和串行传输的转换
   >
   > - 实现链路层的以太网协议
   >
   > <img src="../../../Documents(%E8%B5%84%E6%96%99)/Learning/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%B0%8F%E6%B2%88/img/image-20201115194918353.png" alt="image-20201115194918353" style="zoom:80%;" />
   >
   >   计算机是通过适配器与局域网进行通信的。物理地址MAC放在适配器里，IP地址放在存储器里。

#### ⑤ CSMA/CD协议

   1. 引入

      > <img src="https://i.loli.net/2020/10/25/jGCpMR5xImlaJeu.png" alt="image-20201019154120639" style="zoom:67%;" />
      >
      > 信道复用允许用户使用一个共享信道进行数据通信，以达到降低成本，提高信道利用率的目的。
      >
      > author大白话：
      >
      > 在远距离通信的时候，如果要为每两个基站单独架设一根信道的成本太大，而且当它们之前不通信时，信道就空闲下来了，利用率太低。因此我们就想要在同一个高速信道上同时传输多个用户的数据。
      >
      > 但是，这就产生了一个问题。接收站要怎么区分这段数据是发送给哪个用户的呢?
      >
      > 信道复用技术就是用于解决这个问题的：多个用户在同一条高速链路上传输的问题。
      >
      > 信道复用技术有：
      >
      > - 频分复用FDM
      > - 时分复用TDM
      > - 统计时分复用(TDM的2.0版本)
      > - 波分复用WDM(光信号的频分复用)
      > - 码分复用CDM
      
   2. FDM
   
      > 将带宽分为多份，每个用户占用一个频带，互不干扰
      >
      > **同一时间占用不同的频带**
      >
      > <img src="https://i.loli.net/2020/10/25/WzNZCXIwJs3SLue.png" alt="image-20201025100019422" style="zoom:50%;" />
   
   3. TDM
   
      > 类似于操作系统的时间片轮转，将时间划分为一段段等长的时分复用帧（TDM帧）。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。
      >
      > **不同时间占用同一频带**
   
   4. STDM
   
      > 由于计算机数据的突发性，TDM会造成线路资源的浪费，导致信道利用率不高。
      >
      > STDM帧不是固定分配的,而是按需动态分配的，从而提高信道的利用率。
   
   5. WDM
   
      > 光的频分复用，依赖光复用器和光分用器实现
   
   6. CDM(划重点)
   
      > 每个用户都有自己的码片序列，比如S用户的码片序列是(00011011)。发送1给S用户时，就发送原码片序列(00011011)，发送0给S用户时，就发送码片序列的反码(11100100)。
      >
      > S站在接收到总的发送信号后，可以通过自身的码片序列还原出发送站发给自己的是0还是1。
      >
      > <img src="https://i.loli.net/2020/10/25/zXS1ea2xjbTi4q7.png" alt="image-20201025101350848" style="zoom:80%;" />
      >
      > 但是给每个用户的码片序列也是有要求的，不能乱给。要求每个用户的码片序列相互之间必须正交。内积为0
      >
      > **例题：**
      >
      > 共有四个站进行码分多址CDMA通信，四个站的码片序列为：
      >
      > A：(-1 -1 -1 +1 +1 -1 +1 +1)
      >
      > B：(-1 -1 +1 -1 +1 +1 +1 -1)
      >
      > C：(-1 +1 -1 +1 +1 +1 -1 -1)
      >
      > D：(-1 +1 -1 -1 -1 -1 +1 -1)
      >
      > 现在收到这样的码片序列T：(-1 +1 -3 +1 +1 -3 +1 +1)。问哪个站发送数据了，发送的是0还是1？
      >
      > **题解：**
      >
      > - T和A的内积为8，除以码片序列的长度8，结果为1。因此A发送了1
      > - 同理，得出B、C、D发送了什么
      >
      > (# 0为没有发送，1为发送了1，-1为发送了0)

#### ⑥ 物理层的习题

强推B站up🐖教书匠的计网微课堂！！

[物理层习题](https://www.bilibili.com/video/BV1L4411y7QV/)