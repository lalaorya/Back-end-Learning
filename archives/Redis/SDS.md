# SDS

## 引言

Redis 并没有使用C语言定义的字符串常量，而是自己构建了一种新的字符串抽象类型（simple dynamic string），并使用其作为 **Redis 默认的字符串表示**。

字符串在 Redis 中的应用非常广，基本所有的键/值都是用字符串表示的。

举个栗子：

`set msg "helloSDS"`

- 键的value为一个“msg”的SDS字符串
- 值的value为一个“helloSDS”的SDS字符串

` set msglist "helloSDS","helloRedis",'helloList'` 

- 键的key为一个“msglist ”的SDS字符串
- 值的value为一个list列表，list有三个SDS字符串

举这些例子的目的只是为了说明字符串在 Redis 中应用有多广泛

## SDS的底层实现

### C语言原生字符串的底层实现

估计很多人都忘了C语言的字符串底层是怎么实现的

> 在 C 语言中，字符串实际上是使用 字符 **\0** 终止的**一维字符数组 char []**。因此，一个以 **\0** 结尾的字符串，包含了组成字符串的字符。

C 语言的字符串是一个字符数组，以 \0 终止，但是 \0 字符并不计入字符串长度。**也就是说分配字符串空间时要多分配一个字节存储 \0** 

![image-20210520152025001](https://i.loli.net/2021/05/20/EgV3QJYyTFWsilP.png)

这个字符串需要的内存空间为6个字符，但是`len(str)=5`

### SDS的底层实现

是一个结构体类型，底层同样为字符数组，但是多了两个属性，这两个属性有大用，是SDS优于原生字符串的关键。

![image-20210520152315803](https://i.loli.net/2021/05/20/OE3km7QnpxuVlMY.png)

SDS 同样遵循 C 字符串以 \0 结尾的规则，分配 SDS 空间时同样要分配一个字节存储 \0，并且此字节不计入len(str)。这样设计的目的不是为了标识字符串结尾，redis标识字符串结尾可以使用 len 字段，而是为了复用 <String.h> 库的一部分函数。

## SDS 的五大优越性

### 1. 常数复杂度获取字符串长度

C语言原生字符串获取字符串长度需要从头遍历，复杂度为O(N)。SDS的len字段记录了SDS保存的字符串的长度，访问此字段即可获得字符串长度，时间复杂度为O(1)。

### 2. 杜绝了缓冲区溢出

因为C语言没有记录自身长度，因此字符串扩容时有可能会造成缓冲区溢出。

举个例子：

内存中有两个紧挨着的字符串s1和s2

![image-20210520153525793](https://i.loli.net/2021/05/20/K4dNscTuSH5qjxi.png)

如果此时对s1扩容`strcat(s1," Cluster")`

s1的数据就会溢出到s2的空间，导致s2的内容被意外修改

![image-20210520153716313](https://i.loli.net/2021/05/20/QOtTMvGS4jKa8Xn.png)

而SDS不同，在对字符串扩容时会先判断内存空间是否足够（free字段 > 需要的字节数）。如果不满足会先为SDS重新分配内存。杜绝了缓冲区溢出的情况。

### 3. 特殊的空间分配策略减少内存重分配的次数

原生的C语言字符串的空间是不变的。比如char[5]这个字符串里面的字符数肯定是5个。**增长或者缩短字符串都要对该字符串进行一次内存空间重分配。**

而内存重分配又是一个十分耗时的工作。下面我们来看看SDS是怎么减少重分配的次数的。

- **空间预分配策略（增长字符串）**

  当对一个SDS进行空间扩展的时候，程序不仅会为SDS分配修改所必须的空间，还会为SDS分配额外的未使用（free）空间

  比如对“Redis”这个字符串s执行此函数`sdscat(s,"Hello")`。

  - 扩容前：s:len=5；s:free=0；buf.len=5;

  - 扩容后：s:len=10；s:free=10；bur.len=20;

  redis 额外分配的空间数量有两种情况：

  1. 如果对SDS进行修改后，len字段的值小于1MB，free=len，也就是说额外分配和已分配内存同样大小的空间
  2. 如果对SDS进行修改后，len字段的值大于等于1MB，free=1MB，也就是说额外分配固定为1MB

  通过预分配策略，redis可以减少连续执行字符串增长操作所需的内存重分配次数

- **惰性分配策略（缩短字符串）**

  需要释放的内存空间不会被释放，而是作为未使用空间（free）保留在SDS里面。这些未使用空间以后可能会派上用场。

  比如对“ReYYdiYYsYY”这个字符串s执行此函数`sdstrim(s,"Y")`，来移除所有的Y。

  - 缩小前：s:len=11；s:free=0；buf.len=11;

  - 缩小后：s:len=5；s:free=6；buf.len=11;

### 4. 二进制安全

SDS不仅仅只能保存文本文件，还能保存图片、音频、视频这样的二进制数据。原因是判断字符串结束不再是以 \0 ,而是采用长度len字段。

### 5. 兼容部分C字符串函数

## 参考

- [Redis设计与实现](http://redisbook.com/)